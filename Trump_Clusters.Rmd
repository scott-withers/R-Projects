---
title: "Trump Voters Demographic Clusters"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#####This is an R Markdown document. 

The purpose of this project was to attempt to cluster demographic and socio-economic data of Donald Trump supporters. The data contains results from primary races as of March 2016, which is the reason why every state is not represented. 

```{r results, echo=F}
results <- read.csv("C:/Users/witherssw/iCloudDrive/Documents/Grad - UNCC/KDD/Withers Project/US Election Dataset/primary_results.csv")
```

Here, we can see how many candidates received at least one vote, and that the dataset only contains votes for candidates whose party is either republican or democrat.
```{r explore, tidy=T}
unique(results$candidate)
unique(results$party)
```

####Creating a dataset based on the ratio of votes.  
Using the package sqldf allows the use of SQL syntax to be used in an R environment, most have experience in SQL and find it easier than R. The package, just like SQL, enables the use of grouping by one or more variables. Here, I create a new dataset that first sums _fractionVotes_, the share of votes received regardless of party affiliation, and then group the results by _fips_ and _party_. _fips_ is the Federal Information Processing Standards (FIPS) code which uniquely identifies counties. Next, I averaged those ratios across each _state_.
```{r data, message=F, warning=F}
library(sqldf)
partyRatio <- sqldf("select state, state_abbreviation, fips, party, 
                    sum(fractionVotes) as ratio from results group by fips, party")
partyRatio <- sqldf("select state, state_abbreviation, party, avg(ratio) as republican_ratio
                    from partyRatio group by state, party")
partyRatio <- subset(partyRatio, partyRatio$party=="Republican")
```

Using the package ggplot2 and the dataset made above, we can now create a choropleth map based on the ratio of votes. Notice the colors, red for republican and blue for democrat, we can see how contested, or non-contested, each state is. A color of purple indicates a divided state, and the more pronounced a party's colors the higher the ratio.
```{r ggplot, echo=F, warning=F, message=F}
library(ggplot2)
states_map <- map_data("state")
partyRatio$state1 <- tolower(partyRatio$state)
ggplot(partyRatio, aes(map_id=partyRatio$state1)) + 
  geom_map(aes(fill=partyRatio$republican_ratio), map=states_map, color="black") + 
  expand_limits(x=states_map$long, y=states_map$lat) +
  theme(axis.ticks=element_blank(), axis.title=element_blank(), axis.text=element_blank()) +
  scale_fill_gradient(low="blue", high="red") + guides(fill=F)
```

####Creating a dataset of counties won by each Republican candidate  
Next we will create a dataset that only contains Republican candidates and make a new feature _winner_ that identifies which candidate won that county via highest _fractionVotes_ received. The stateCount datset is used to build the bar chart below, _countieswon_ is just the count of _winner_ per state and candidate.
```{r republican_results, message=F, warning=F}
library(sqldf)
library(dplyr)
republican_results <- subset(results, results$party == "Republican")
countyWinner <- republican_results %>% group_by(state,fips)
countyWinner <- summarize(countyWinner, winner=candidate[which.max(fractionVotes)])
countyWinner$winner <- factor(countyWinner$winner)
stateCount <- sqldf("select state, winner, count(winner) as 
                    countieswon from countyWinner group by state, winner")
```

```{r bar, echo=F, warning=F, message=F}
library(ggplot2)
ggplot(data=stateCount, aes(state,countieswon, fill=winner)) + 
  geom_bar(colour="black", stat="identity", position="dodge") + 
  coord_flip() + scale_fill_brewer(palette = "Accent") + 
  xlab("State") + ylab("Counties Won") + 
  guides(fill=guide_legend(title="Republican Candidate")) + 
  ggtitle("Grouped Bar Chart of Primary Republican Candidates")
```

####Demographic Clusters  
```{r, echo=F }
county_demo <- read.csv("C:/Users/witherssw/iCloudDrive/Documents/Grad - UNCC/KDD/Withers Project/US Election Dataset/county_facts.csv")
```
Subsetting county demographics by only keeping relevant variables. To make it easier for future, and current, analysis the variables were renamed according to what they are describing in the codebook. Also, below two datasets are joined together. I filtered out every candidate except for Donald Trump or Ted Cruz. The dataset, where it is now, was used for some other analysis not present in this document. Eventually, a dummy variable is created to indicate whether Donald Trump won a particular county or not. 
```{r}
library(dplyr)
demographics <- subset(county_demo, select=c("fips", "area_name", "AGE295214", "AGE775214", "SEX255214",                                                    "RHI125214", "RHI225214", "RHI325214", "RHI425214",                                                            "RHI525214", "RHI725214", "POP645213", "EDU635213",                                                            "EDU685213", "VET605213", "HSG445213", "INC910213",                                                            "INC110213", "PVY020213", "POP060210"))
colnames(demographics)[3:20] <- c("Young_Citizens", "Old_Citizens", "Female_Percent",
                                  "White_Percent", "AfricanAmerican_Percent", "AmericanIndian_Percent",
                                  "Asians_Percent", "HawaiianPacific_Percent", "HispanicLatino_Percent", 
                                  "ForeignBorn_Percent","HighSchoolGrad_Percent","BachDegreeHigher_Percent",
                                  "Veterans", "HomeOwner_Rate", "PerCapitaIncome", "MedianHouseholdInc", 
                                  "PovertyLevel_Percent", "Population_Density")
#Join countyWinner and demographics data by an inner join
Republican_Demo <- inner_join(countyWinner, demographics, by="fips")
#filter out results that are not Donald Trump or Ted Cruz
Republican_Demo <- Republican_Demo %>% filter(winner=="Donald Trump" | 
                                              winner=="Ted Cruz")
#Drop irrelevant variables
Republican_Demo <- Republican_Demo[-c(1, 2, 4)]

#Create dummy variables for the winner variable
Republican_Demo$winner <- factor(Republican_Demo$winner)
dummy <- model.matrix(~winner-1, data=Republican_Demo)
joined <- cbind(Republican_Demo[match(rownames(dummy), rownames(Republican_Demo)),], dummy)
Republican_Demo <- subset(joined, select=-c(winner))
```

####Just how many clusters?  
To determine _k_, I frequently use what is commonly referred to as the "elbow" method. Take a look at the plot below, is there anything that stands out, perhaps a bend, or an elbow? When I look at this line graph I say the bend takes place at 4, what do you think?  

```{r elbow, echo=F}
wss <- (nrow(Republican_Demo)-1)*sum(apply(Republican_Demo, 2, var)) 
         for (i in 2:15) wss[i] <- sum(kmeans(Republican_Demo, centers=i, 
                                              iter.max=1000, 
                                              algorithm="MacQueen")$withinss)
plot(1:15, wss, type="b", xlab="Number of Clusters (Republican)", ylab="Within Group Sum of Squares")
```

####Running the k-means algorithm
```{r kmeans, warning=F, message=F}
library(fpc)
trump_k <- kmeans(Republican_Demo, centers=4,iter.max=1000,algorithm="MacQueen")
trump_k$size
trump_k$withinss
as.data.frame(aggregate(Republican_Demo, by=list(cluster=trump_k$cluster), FUN=mean))
projections <- discrproj(Republican_Demo, trump_k$cluster)
Republican_Demo$clustname <- trump_k$cluster
Republican_Demo$clustname <- factor(Republican_Demo$clustname)
```

####Plotting the 4 clusters
```{r clusters, echo=F, warning=F, message=F}
library(ggplot2)
ggplot(Republican_Demo, aes(projections$proj[,1], projections$proj[,2], color=factor(trump_k$cluster))) +
  geom_point(size=2) + scale_x_reverse(lim=c(0, -40)) + 
  scale_color_manual(values=c("#d11141", "#00b159", "#00aedb", "#f37735")) +
  ggtitle("Demographic Clusters (4)")
```

####Counties won in each cluster by Donald Trump
```{r, echo=F}
library(ggplot2)
ggplot(Republican_Demo, aes(projections$proj[,1], projections$proj[,2], color=factor(Republican_Demo$`winnerDonald Trump`))) + geom_point(pch=19,size=2) + facet_grid(clustname~.) + scale_color_manual(values=c("#545454", "#e52222")) + ggtitle("Counties won by Donald Trump in each Cluster")
```

####Findings and Interpretations  
While clustering is extremely useful, the output can be hard to interpret. Initially we have
no clue as to what these clusters mean or what they represent. Just look at the plot above,
yes it is certainly pretty and nice to look at it but what does it mean? To help with this
problem I will look at the mean of all the variables in each cluster and try to define what
each cluster is. Looking at the means of each cluster it becomes clear that there are
differences among them, for example the median household income is much higher in the
"Rising Prosperity" cluster than the "Rural" cluster; same goes go for poverty percentage
as well.

Below is a breakdown of the 4 clusters identified:  

**Metropolitan**: 1% of the counties fall into this cluster. This cluster has the largest
percentages of young voters and African Americans Asian, and Hispanic ethnicities; as
well as the highest percentage of foreign-born persons. This cluster also has a high
poverty rate, 17%, and the lowest homeowner rate, 61.5%. Unsurprisingly, boasting the
highest population density too. Donald Trump has won nearly 70% of the counties in the
cluster.  

**Urban**: 5% of the counties fall into this cluster. They have a good mixed proportion of
the White, African American, Asian, and Hispanic ethnicities, as well as foreign-born
voters. This cluster is where you will find the highest educated and wealthiest citizens
(median household income, ~$55,000) in the dataset. Donald Trump has won 72% of the
counties in the cluster.  

**Rising Prosperity**: 30% of the counties in the analysis fall into this cluster. This cluster
maintains the highest percentage of white persons and low or lowest percentages of
African Americans, Asians, and Hispanic persons. The homeowner rate is also the
highest in this cluster than the others, while also having a high median household income
and a low poverty rate. Donald Trump has his lowest winning percentage in this cluster,
only winning 53% of the counties in this cluster.  

**Rural**: 64% of the counties in the analysis fall into this cluster. This is the largest cluster
and contains a high percentage of White and African American persons. The ethnicities
with the lowest percentage are Hispanics and Asians, as well as the lowest foreign born
percentage. Other characteristics of the cluster include the least educated, lowest median
income, ~$37,000, and highest poverty level, 21.5%. This cluster has the highest
percentage of Native Americans, 1.67%. Donald Trump has his highest winning
percentage in this cluster, winning 74% of the counties in this cluster.  